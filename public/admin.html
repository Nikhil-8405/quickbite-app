<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard - QuickBite</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Welcome, Admin!</h2>

  <ul>
    <li><button onclick="loadRestaurants()">üè¢ View Restaurants</button></li>
    <li><button onclick="loadUsers()">üë• View Users</button></li>
    <li><button onclick="loadOrders()">üì¶ View Orders</button></li>
    <li><button onclick="loadReport()">üìä System Report</button></li>
  </ul>

  <div id="output"></div>

  <script>
    async function loadRestaurants() {
      const res = await fetch('/api/admin/restaurants');
      const data = await res.json();
      let html = "<h3>Restaurants</h3><table border='1' cellpadding='8'><tr><th>ID</th><th>Name</th><th>Address</th></tr>";
      data.forEach(r => {
        html += `<tr><td>${r.restaurant_id}</td><td>${r.name}</td><td>${r.address}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("output").innerHTML = html;
    }

    async function loadUsers() {
      const res = await fetch('/api/admin/users');
      const data = await res.json();
      let html = "<h3>Users</h3><table border='1' cellpadding='8'><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Restaurant ID</th></tr>";
      data.forEach(u => {
        html += `<tr><td>${u.user_id}</td><td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td>${u.restaurant_id || '-'}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("output").innerHTML = html;
    }

    async function loadOrders() {
      const res = await fetch('/api/admin/orders');
      const orders = await res.json();

      let html = "<h3>All Orders</h3><table border='1' cellpadding='8'><tr><th>ID</th><th>Customer</th><th>Restaurant</th><th>Items</th><th>Total</th><th>Status</th><th>Time</th><th>Update</th></tr>";
      orders.forEach(order => {
        const items = order.items.length > 0 ? order.items.join(", ") : "No items";
        const orderTime = new Date(order.order_time).toLocaleString();
        html += `<tr>
          <td>${order.order_id}</td>
          <td>${order.customer}</td>
          <td>${order.restaurant}</td>
          <td>${items}</td>
          <td>‚Çπ${order.total_amount}</td>
          <td>${order.status}</td>
          <td>${orderTime}</td>
          <td>
            <select onchange="updateStatus(${order.order_id}, this.value)">
              <option value="">--Change--</option>
              <option value="Accepted">Accepted</option>
              <option value="Preparing">Preparing</option>
              <option value="Delivered">Delivered</option>
            </select>
          </td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("output").innerHTML = html;
    }

    async function updateStatus(orderId, newStatus) {
      if (!newStatus) return;
      const res = await fetch(`/api/admin/orders/${orderId}/status`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });
      if (res.ok) {
        alert("Status updated!");
        loadOrders();
      } else {
        alert("Failed to update status");
      }
    }

    async function loadReport() {
      const res = await fetch('/api/admin/report');
      const data = await res.json();

      const fmt = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' });

      let totalOrders = 0;
      let totalRevenue = 0;

      let html = "<h3>System Report</h3><table border='1' cellpadding='8'><tr><th>Restaurant</th><th>Total Orders</th><th>Total Revenue</th></tr>";

      data.forEach(r => {
        const orders = Number(r.total_orders) || 0;              // ensure number
        const revenue = parseFloat(r.total_revenue) || 0;        // ensure number

        totalOrders += orders;
        totalRevenue += revenue;

        html += `<tr>
          <td>${r.restaurant}</td>
          <td>${orders}</td>
          <td>${fmt.format(revenue)}</td>
        </tr>`;
      });

      // ‚úÖ totals row
      html += `<tr style="font-weight:bold;background:#f0f0f0;">
        <td>Total</td>
        <td>${totalOrders}</td>
        <td>${fmt.format(totalRevenue)}</td>
      </tr>`;

      html += "</table>";
      document.getElementById("output").innerHTML = html;
    }

  </script>
</body>
</html>
