<!DOCTYPE html>
<html>
<head>
  <title>Restaurant Dashboard - QuickBite</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2 id="welcome">Welcome, Restaurant!</h2>

  <ul>
    <li><button onclick="loadOrders()">üì¶ View Orders</button></li>
    <li><button onclick="loadReport()">üìä View Report</button></li>
    <li><button onclick="loadMenu()">üç¥ Manage Menu</button></li>
  </ul>

  <div id="output"></div>

  <script>
    const restaurantId = localStorage.getItem("restaurant_id");
    if (!restaurantId) {
      alert("No restaurant linked to this account.");
      window.location.href = "login.html";
    }

    // ‚úÖ Fetch restaurant name on load
    window.onload = async function() {
      const res = await fetch(`/api/restaurant/details/${restaurantId}`);
      if (res.ok) {
        const data = await res.json();
        document.getElementById("welcome").innerText = `Welcome, ${data.name}!`;
      }
    };

    // ‚úÖ Orders
    async function loadOrders() {
      const res = await fetch(`/api/restaurant/orders/${restaurantId}`);
      const orders = await res.json();

      let html = "<h3>Orders</h3><table border='1' cellpadding='8'><tr><th>ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Time</th><th>Update</th></tr>";
      orders.forEach(order => {
        const items = order.items.length > 0 ? order.items.join(", ") : "No items";
        const orderTime = new Date(order.order_time).toLocaleString();

        html += `<tr>
          <td>${order.order_id}</td>
          <td>${order.customer}</td>
          <td>${items}</td>
          <td>‚Çπ${order.total_amount}</td>
          <td>${order.status}</td>
          <td>${orderTime}</td>
          <td>
            <select onchange="updateStatus(${order.order_id}, this.value)">
              <option value="">--Change--</option>
              <option value="Accepted">Accepted</option>
              <option value="Preparing">Preparing</option>
              <option value="Delivered">Delivered</option>
            </select>
          </td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("output").innerHTML = html;
    }

    async function updateStatus(orderId, newStatus) {
      if (!newStatus) return;
      const res = await fetch(`/api/restaurant/update-status/${orderId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });
      if (res.ok) {
        alert("Status updated!");
        loadOrders();
      } else {
        alert("Failed to update");
      }
    }

    // ‚úÖ Report
    async function loadReport() {
      const res = await fetch(`/api/restaurant/report/${restaurantId}`);
      const r = await res.json();
      const fmt = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' });

      const html = `
        <h3>Report</h3>
        <p><strong>Total Orders:</strong> ${r.total_orders || 0}</p>
        <p><strong>Total Revenue (Subtotal):</strong> ${fmt.format(r.total_revenue || 0)}</p>
        <p><strong>Total Commission:</strong> ${fmt.format(r.total_commission || 0)}</p>
        <p><strong>Net Earnings (Revenue - Commission):</strong> ${fmt.format(r.net_earnings || 0)}</p>
      `;
      document.getElementById("output").innerHTML = html;
    }

    // ‚úÖ Menu
    async function loadMenu() {
      const res = await fetch(`/api/restaurant/menu/${restaurantId}`);
      const items = await res.json();

      let html = "<h3>Menu</h3><table border='1' cellpadding='8'><tr><th>Name</th><th>Description</th><th>Price</th><th>Action</th></tr>";
      items.forEach(it => {
        html += `<tr>
          <td>${it.name}</td>
          <td>${it.description || ''}</td>
          <td>‚Çπ${it.price}</td>
          <td><button onclick="deleteItem(${it.menu_item_id})">‚ùå Delete</button></td>
        </tr>`;
      });
      html += "</table>";

      html += `
        <h4>Add New Item</h4>
        <input id="newName" placeholder="Name">
        <input id="newDesc" placeholder="Description">
        <input id="newPrice" type="number" placeholder="Price">
        <button onclick="addItem()">Add</button>
      `;

      document.getElementById("output").innerHTML = html;
    }

    async function addItem() {
      const name = document.getElementById("newName").value.trim();
      const description = document.getElementById("newDesc").value.trim();
      const price = parseFloat(document.getElementById("newPrice").value);

      if (!name || isNaN(price)) {
        return alert("Provide valid name and price");
      }

      const res = await fetch("/api/restaurant/add-item", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ restaurant_id: restaurantId, name, description, price })
      });

      if (res.ok) {
        alert("Item added");
        loadMenu();
      } else {
        alert("Failed to add item");
      }
    }

    async function deleteItem(id) {
      const res = await fetch(`/api/restaurant/delete-item/${id}`, { method: "DELETE" });
      if (res.ok) {
        alert("Item deleted");
        loadMenu();
      } else {
        alert("Failed to delete item");
      }
    }
  </script>
</body>
</html>
